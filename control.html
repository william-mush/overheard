<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overheard - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', sans-serif;
            background: #111;
            color: #fff;
            min-height: 100vh;
            padding: 30px;
        }

        /* Authentication Gate Styles */
        .auth-gate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-gate.hidden {
            display: none;
        }

        .auth-box {
            background: #1a1a1a;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .auth-box h2 {
            color: #4af;
            font-weight: 300;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .auth-box p {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            background: #222;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            text-align: center;
            letter-spacing: 3px;
            margin-bottom: 20px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #4af;
        }

        .auth-input.error {
            border-color: #ff4444;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #4af;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-btn:hover {
            background: #5bf;
        }

        .auth-error {
            color: #ff4444;
            font-size: 14px;
            margin-top: 15px;
            display: none;
        }

        .main-content {
            display: none;
        }

        .main-content.visible {
            display: block;
        }

        h1 {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 4px;
            margin-bottom: 30px;
            color: #4af;
        }

        .status-bar {
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .open-display-btn {
            margin-left: auto;
            padding: 10px 20px;
            background: #4af;
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .open-display-btn:hover {
            background: #5bf;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-indicator.connected {
            background: #44ff44;
            box-shadow: 0 0 10px #44ff44;
        }

        .status-text {
            font-size: 14px;
            color: #888;
        }

        .control-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .control-section h2 {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 2px;
            color: #666;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .mode-btn {
            background: #222;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            text-align: center;
        }

        .mode-btn:hover {
            background: #333;
            border-color: #4af;
        }

        .mode-btn.active {
            background: #4af;
            color: #000;
            border-color: #4af;
        }

        .mode-btn.art {
            border-color: #cc0000;
        }

        .mode-btn.art:hover {
            border-color: #ff0000;
        }

        .mode-btn.art.active {
            background: #cc0000;
            border-color: #cc0000;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .slider-group label {
            width: 100px;
            font-size: 14px;
            color: #888;
        }

        .slider-group input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
            outline: none;
        }

        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #4af;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            width: 50px;
            text-align: right;
            font-size: 14px;
            color: #4af;
        }

        .speaker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .speaker-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #222;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speaker-item:hover {
            background: #333;
        }

        .speaker-item.selected {
            background: #333;
            border: 1px solid #4af;
        }

        .speaker-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .speaker-name {
            flex: 1;
            font-size: 14px;
        }

        .speaker-count {
            font-size: 12px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #4af;
            color: #000;
        }

        .action-btn.primary:hover {
            background: #5bf;
        }

        .action-btn.secondary {
            background: #333;
            color: #fff;
        }

        .action-btn.secondary:hover {
            background: #444;
        }

        .action-btn.danger {
            background: #cc0000;
            color: #fff;
        }

        .action-btn.danger:hover {
            background: #ff0000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-box {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 300;
            color: #4af;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .current-quote {
            background: #222;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .current-quote-text {
            font-family: Georgia, serif;
            font-size: 18px;
            line-height: 1.5;
            color: #ccc;
            font-style: italic;
        }

        .current-quote-speaker {
            margin-top: 10px;
            font-size: 14px;
            color: #888;
        }

        .timing-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .timing-control {
            background: #222;
            padding: 15px;
            border-radius: 8px;
        }

        .timing-control label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timing-control input {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #333;
            border-radius: 3px;
        }

        .timing-control input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #cc0000;
            border-radius: 50%;
            cursor: pointer;
        }

        .timing-value {
            text-align: center;
            font-size: 14px;
            color: #cc0000;
            margin-top: 8px;
        }

        .contradiction-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .contradiction-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: #222;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid #cc0000;
        }

        .contradiction-item:hover {
            background: #2a2a2a;
        }

        .contradiction-item.disabled {
            opacity: 0.4;
            border-left-color: #444;
        }

        .contradiction-item input[type="checkbox"] {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            accent-color: #cc0000;
        }

        .contradiction-content {
            flex: 1;
        }

        .contradiction-speaker {
            font-size: 11px;
            color: #cc0000;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .contradiction-topic {
            font-size: 14px;
            color: #fff;
            margin-bottom: 6px;
        }

        .contradiction-preview {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .contradiction-quotes {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contradiction-quote-box {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 12px;
            border-left: 2px solid #444;
        }

        .contradiction-quote-box.quote1 {
            border-left-color: #4a9eff;
        }

        .contradiction-quote-box.quote2 {
            border-left-color: #ff6b6b;
        }

        .contradiction-quote-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .contradiction-quote-text {
            font-size: 13px;
            color: #ddd;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .contradiction-quote-meta {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: #666;
        }

        .contradiction-quote-date {
            color: #888;
        }

        .contradiction-quote-source {
            color: #4a9eff;
            text-decoration: none;
        }

        .contradiction-quote-source:hover {
            text-decoration: underline;
        }

        .contradiction-delete {
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }

        .contradiction-delete:hover {
            color: #ff4444;
        }

        /* Filter Section Styles */
        .filter-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 3px solid #4af;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-group select,
        .filter-group input[type="text"],
        .filter-group input[type="date"] {
            width: 100%;
            padding: 10px 12px;
            background: #222;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #4af;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-chip {
            padding: 6px 12px;
            background: #222;
            border: 1px solid #333;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: #4af;
        }

        .filter-chip.active {
            background: #4af;
            color: #000;
            border-color: #4af;
        }

        .filter-chip.category {
            border-color: #44aa44;
        }

        .filter-chip.category.active {
            background: #44aa44;
            border-color: #44aa44;
        }

        .filter-chip.rhetoric {
            border-color: #aa4444;
        }

        .filter-chip.rhetoric.active {
            background: #aa4444;
            border-color: #aa4444;
        }

        .filter-chip.factcheck {
            border-color: #aaaa44;
        }

        .filter-chip.factcheck.active {
            background: #aaaa44;
            color: #000;
            border-color: #aaaa44;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 35px;
        }

        .search-box::before {
            content: "\\1F50D";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.5;
        }

        .filter-summary {
            background: #222;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 13px;
            color: #888;
            margin-top: 15px;
        }

        .filter-summary strong {
            color: #4af;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .preset-btn {
            padding: 8px 16px;
            background: #333;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: #444;
            border-color: #4af;
        }

        .preset-btn.active {
            background: #4af;
            color: #000;
            border-color: #4af;
        }
    </style>
</head>
<body>
    <!-- Authentication Gate -->
    <div class="auth-gate" id="authGate">
        <div class="auth-box">
            <h2>CONTROL PANEL</h2>
            <p>Enter access code to continue</p>
            <input type="password" class="auth-input" id="authInput" placeholder="••••••••" autocomplete="off">
            <button class="auth-btn" id="authBtn">Access</button>
            <div class="auth-error" id="authError">Invalid access code</div>
        </div>
    </div>

    <!-- Main Content (hidden until authenticated) -->
    <div class="main-content" id="mainContent">
        <h1>OVERHEARD CONTROL PANEL</h1>

        <div class="status-bar">
        <div class="status-indicator" id="connectionStatus"></div>
        <span class="status-text" id="connectionText">Connecting to display...</span>
        <button class="open-display-btn" onclick="window.open('/', 'OverheardDisplay', 'fullscreen=yes')">Open Display Window</button>
    </div>

    <!-- Stats -->
    <div class="control-section">
        <h2>Live Stats</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="quotesShown">0</div>
                <div class="stat-label">Quotes Shown</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="currentMode">--</div>
                <div class="stat-label">Current Mode</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="currentSpeaker">--</div>
                <div class="stat-label">Current Speaker</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="totalQuotes">93</div>
                <div class="stat-label">Total Quotes</div>
            </div>
        </div>
    </div>

    <!-- Flow Mode Selection -->
    <div class="control-section">
        <h2>Display Mode</h2>
        <div class="mode-grid">
            <button class="mode-btn" data-mode="wave">Wave Flow</button>
            <button class="mode-btn" data-mode="typewriter">Typewriter</button>
            <button class="mode-btn" data-mode="chaos">Chaos</button>
            <button class="mode-btn" data-mode="matrix">Matrix Rain</button>
            <button class="mode-btn" data-mode="cascade">Cascade</button>
            <button class="mode-btn" data-mode="ticker">News Ticker</button>
        </div>

        <h2 style="margin-top: 25px;">Political Art Modes</h2>
        <div class="mode-grid">
            <button class="mode-btn art" data-mode="therecord">The Record</button>
            <button class="mode-btn art" data-mode="accumulation">Accumulation</button>
            <button class="mode-btn art" data-mode="contradiction">Contradiction</button>
            <button class="mode-btn art" data-mode="factcheck">Fact Check</button>
            <button class="mode-btn art" data-mode="correction">The Correction</button>
            <button class="mode-btn art" data-mode="whosaidit">Who Said It?</button>
        </div>
    </div>

    <!-- Speed & Density -->
    <div class="control-section">
        <h2>Display Settings</h2>
        <div class="slider-group">
            <label>Speed</label>
            <input type="range" id="speedSlider" min="1" max="10" value="5">
            <span class="slider-value" id="speedValue">5</span>
        </div>
        <div class="slider-group">
            <label>Density</label>
            <input type="range" id="densitySlider" min="1" max="10" value="5">
            <span class="slider-value" id="densityValue">5</span>
        </div>
    </div>

    <!-- Speaker Selection -->
    <div class="control-section">
        <h2>Speaker Filter</h2>
        <div class="speaker-grid" id="speakerGrid">
            <!-- Populated by JavaScript -->
        </div>
        <div class="action-buttons">
            <button class="action-btn primary" id="selectAll">Select All</button>
            <button class="action-btn secondary" id="selectNone">Select None</button>
        </div>
    </div>

    <!-- Content Filters -->
    <div class="filter-section">
        <h2>Content Filters</h2>

        <!-- Quick Presets -->
        <div class="preset-buttons" id="presetButtons">
            <button class="preset-btn active" data-preset="all">All Content</button>
            <button class="preset-btn" data-preset="contradictions">Contradictions Only</button>
            <button class="preset-btn" data-preset="factcheck">Fact-Checked False</button>
            <button class="preset-btn" data-preset="immigration">Immigration</button>
            <button class="preset-btn" data-preset="election">Election Claims</button>
            <button class="preset-btn" data-preset="dehumanizing">Dehumanizing Language</button>
        </div>

        <!-- Search -->
        <div class="filter-row">
            <div class="filter-group" style="flex: 2;">
                <label>Search Quotes</label>
                <div class="search-box">
                    <input type="text" id="quoteSearch" placeholder="Search quote text...">
                </div>
            </div>
            <div class="filter-group">
                <label>Date Range</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="dateFrom" placeholder="From">
                    <input type="date" id="dateTo" placeholder="To">
                </div>
            </div>
        </div>

        <!-- Category Chips -->
        <div class="filter-row">
            <div class="filter-group">
                <label>Topics</label>
                <div class="filter-chips" id="categoryChips">
                    <span class="filter-chip category" data-category="immigration">Immigration</span>
                    <span class="filter-chip category" data-category="election">Election</span>
                    <span class="filter-chip category" data-category="economy">Economy</span>
                    <span class="filter-chip category" data-category="media">Media</span>
                    <span class="filter-chip category" data-category="opponents">Opponents</span>
                    <span class="filter-chip category" data-category="military">Military</span>
                    <span class="filter-chip category" data-category="healthcare">Healthcare</span>
                </div>
            </div>
        </div>

        <!-- Rhetoric Chips -->
        <div class="filter-row">
            <div class="filter-group">
                <label>Rhetoric Type</label>
                <div class="filter-chips" id="rhetoricChips">
                    <span class="filter-chip rhetoric" data-rhetoric="dehumanizing">Dehumanizing</span>
                    <span class="filter-chip rhetoric" data-rhetoric="violent">Violent</span>
                    <span class="filter-chip rhetoric" data-rhetoric="absolutist">Absolutist</span>
                    <span class="filter-chip rhetoric" data-rhetoric="victimhood">Victimhood</span>
                    <span class="filter-chip rhetoric" data-rhetoric="conspiracy">Conspiracy</span>
                </div>
            </div>
        </div>

        <!-- Fact Check Filter -->
        <div class="filter-row">
            <div class="filter-group">
                <label>Fact-Check Rating</label>
                <div class="filter-chips" id="factcheckChips">
                    <span class="filter-chip factcheck" data-factcheck="false">False</span>
                    <span class="filter-chip factcheck" data-factcheck="pants-on-fire">Pants on Fire</span>
                    <span class="filter-chip factcheck" data-factcheck="mostly-false">Mostly False</span>
                    <span class="filter-chip factcheck" data-factcheck="half-true">Half True</span>
                    <span class="filter-chip factcheck" data-factcheck="unverified">Unverified</span>
                </div>
            </div>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary" id="filterSummary">
            Showing <strong id="filteredCount">0</strong> of <strong id="totalCount">0</strong> quotes
        </div>

        <div class="action-buttons">
            <button class="action-btn primary" id="applyFilters">Apply Filters</button>
            <button class="action-btn secondary" id="clearFilters">Clear All</button>
        </div>
    </div>

    <!-- Timing Controls for Art Modes -->
    <div class="control-section" id="artTimingSection">
        <h2>Art Mode Timing</h2>
        <div class="timing-controls">
            <div class="timing-control">
                <label>Time per Speaker</label>
                <input type="range" id="speakerTime" min="10" max="120" value="30">
                <div class="timing-value"><span id="speakerTimeValue">30</span>s</div>
            </div>
            <div class="timing-control">
                <label>Quote Interval</label>
                <input type="range" id="quoteInterval" min="1" max="10" value="3">
                <div class="timing-value"><span id="quoteIntervalValue">3</span>s</div>
            </div>
            <div class="timing-control">
                <label>Quotes per Speaker</label>
                <input type="range" id="quotesPerSpeaker" min="5" max="50" value="15">
                <div class="timing-value"><span id="quotesPerSpeakerValue">15</span></div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="action-btn primary" id="startArt">Start</button>
            <button class="action-btn secondary" id="skipSpeaker">Skip Speaker</button>
            <button class="action-btn danger" id="stopArt">Stop</button>
        </div>
    </div>

    <!-- Current Display -->
    <div class="control-section">
        <h2>Currently Displaying</h2>
        <div class="current-quote">
            <div class="current-quote-text" id="currentQuoteText">Waiting for content...</div>
            <div class="current-quote-speaker" id="currentQuoteSpeaker"></div>
        </div>
    </div>

    <!-- Contradiction Manager -->
    <div class="control-section">
        <h2>Contradiction Manager</h2>
        <div class="contradiction-list" id="contradictionList">
            <!-- Populated by JavaScript -->
        </div>
        <div class="action-buttons">
            <button class="action-btn primary" id="enableAllContradictions">Enable All</button>
            <button class="action-btn secondary" id="disableAllContradictions">Disable All</button>
        </div>
    </div>
    </div><!-- End main-content -->

    <script>
        // ============================================
        // Authentication System
        // ============================================

        // SHA-256 hash of the access code (change this hash for your password)
        // To generate a new hash:
        // 1. Open browser console
        // 2. Run: crypto.subtle.digest('SHA-256', new TextEncoder().encode('YOUR_PASSWORD')).then(h => console.log(Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('')))
        const ACCESS_CODE_HASH = '25bbb7f68c71ad1a4951a07f155ac53930724d1467dad42257d9ad38fdc46aeb';

        // Session token for BroadcastChannel authentication
        let sessionToken = null;

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generateSessionToken() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkAuth() {
            const storedToken = sessionStorage.getItem('overheard_auth_token');
            const storedTime = sessionStorage.getItem('overheard_auth_time');

            // Check if token exists and is less than 24 hours old
            if (storedToken && storedTime) {
                const elapsed = Date.now() - parseInt(storedTime);
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours

                if (elapsed < maxAge) {
                    sessionToken = storedToken;
                    showMainContent();
                    return true;
                }
            }

            showAuthGate();
            return false;
        }

        // Brute force protection
        const loginAttempts = {
            count: 0,
            lockoutUntil: 0,
            maxAttempts: 5,
            lockoutDuration: 60000 // 60 seconds lockout
        };

        async function attemptAuth() {
            const input = document.getElementById('authInput');
            const error = document.getElementById('authError');
            const now = Date.now();

            // Check if locked out
            if (now < loginAttempts.lockoutUntil) {
                const remaining = Math.ceil((loginAttempts.lockoutUntil - now) / 1000);
                error.textContent = `Too many attempts. Try again in ${remaining}s`;
                error.style.display = 'block';
                input.value = '';
                return;
            }

            const password = input.value;
            const hash = await hashPassword(password);

            if (hash === ACCESS_CODE_HASH) {
                // Reset attempts on success
                loginAttempts.count = 0;

                // Generate session token
                sessionToken = await generateSessionToken();
                sessionStorage.setItem('overheard_auth_token', sessionToken);
                sessionStorage.setItem('overheard_auth_time', Date.now().toString());

                error.style.display = 'none';
                showMainContent();
            } else {
                // Increment failed attempts
                loginAttempts.count++;

                if (loginAttempts.count >= loginAttempts.maxAttempts) {
                    loginAttempts.lockoutUntil = now + loginAttempts.lockoutDuration;
                    loginAttempts.count = 0;
                    error.textContent = `Too many attempts. Locked for 60 seconds.`;
                } else {
                    error.textContent = `Invalid access code (${loginAttempts.maxAttempts - loginAttempts.count} attempts remaining)`;
                }

                input.classList.add('error');
                error.style.display = 'block';
                input.value = '';

                setTimeout(() => {
                    input.classList.remove('error');
                }, 300);
            }
        }

        function showAuthGate() {
            document.getElementById('authGate').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('visible');
        }

        function showMainContent() {
            document.getElementById('authGate').classList.add('hidden');
            document.getElementById('mainContent').classList.add('visible');
            initializeControlPanel();
        }

        // Auth event listeners
        document.getElementById('authBtn').addEventListener('click', attemptAuth);
        document.getElementById('authInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') attemptAuth();
        });

        // Check auth on load
        checkAuth();

        // ============================================
        // Control Panel (only runs after auth)
        // ============================================

        async function initializeControlPanel() {
        // BroadcastChannel for cross-tab communication
        const channel = new BroadcastChannel('overheard-control');
        let isConnected = false;

        // Speakers data (loaded from API)
        let speakers = [];
        let selectedSpeakers = new Set();

        // Load speakers from database
        async function loadSpeakers() {
            try {
                const response = await fetch('/api/data?type=speakers');
                const data = await response.json();
                speakers = Object.entries(data.speakers).map(([id, info]) => ({
                    id,
                    name: info.name,
                    color: info.color,
                    count: info.quoteCount || 0
                }));
                selectedSpeakers = new Set(speakers.map(s => s.id));
                initSpeakerGrid();
            } catch (error) {
                console.error('Failed to load speakers:', error);
                // Fallback to empty array
                speakers = [];
            }
        }

        // Initialize speaker grid
        function initSpeakerGrid() {
            const grid = document.getElementById('speakerGrid');
            grid.textContent = '';

            speakers.forEach(speaker => {
                const item = document.createElement('div');
                item.className = 'speaker-item' + (selectedSpeakers.has(speaker.id) ? ' selected' : '');
                item.dataset.speakerId = speaker.id;

                const colorDot = document.createElement('div');
                colorDot.className = 'speaker-color';
                colorDot.style.background = speaker.color;

                const name = document.createElement('span');
                name.className = 'speaker-name';
                name.textContent = speaker.name;

                const count = document.createElement('span');
                count.className = 'speaker-count';
                count.textContent = speaker.count + ' quotes';

                item.appendChild(colorDot);
                item.appendChild(name);
                item.appendChild(count);

                item.addEventListener('click', () => {
                    if (selectedSpeakers.has(speaker.id)) {
                        selectedSpeakers.delete(speaker.id);
                        item.classList.remove('selected');
                    } else {
                        selectedSpeakers.add(speaker.id);
                        item.classList.add('selected');
                    }
                    sendCommand('setSpeakers', Array.from(selectedSpeakers));
                });

                grid.appendChild(item);
            });
        }

        // Send command to display with authentication token
        function sendCommand(type, data) {
            channel.postMessage({
                type,
                data,
                timestamp: Date.now(),
                token: sessionToken  // Include auth token for verification
            });
        }

        // Mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                sendCommand('setMode', btn.dataset.mode);
                document.getElementById('currentMode').textContent = btn.dataset.mode;
            });
        });

        // Speed slider
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value;
            sendCommand('setSpeed', parseInt(e.target.value));
        });

        // Density slider
        document.getElementById('densitySlider').addEventListener('input', (e) => {
            document.getElementById('densityValue').textContent = e.target.value;
            sendCommand('setDensity', parseInt(e.target.value));
        });

        // Timing sliders - send updates live to display
        document.getElementById('speakerTime').addEventListener('input', (e) => {
            document.getElementById('speakerTimeValue').textContent = e.target.value;
            sendCommand('setTiming', { speakerTime: parseInt(e.target.value) * 1000 });
        });

        document.getElementById('quoteInterval').addEventListener('input', (e) => {
            document.getElementById('quoteIntervalValue').textContent = e.target.value;
            sendCommand('setTiming', { quoteInterval: parseInt(e.target.value) * 1000 });
        });

        document.getElementById('quotesPerSpeaker').addEventListener('input', (e) => {
            document.getElementById('quotesPerSpeakerValue').textContent = e.target.value;
            sendCommand('setTiming', { quotesPerSpeaker: parseInt(e.target.value) });
        });

        // Select all/none
        document.getElementById('selectAll').addEventListener('click', () => {
            selectedSpeakers = new Set(speakers.map(s => s.id));
            document.querySelectorAll('.speaker-item').forEach(item => item.classList.add('selected'));
            sendCommand('setSpeakers', Array.from(selectedSpeakers));
        });

        document.getElementById('selectNone').addEventListener('click', () => {
            selectedSpeakers.clear();
            document.querySelectorAll('.speaker-item').forEach(item => item.classList.remove('selected'));
            sendCommand('setSpeakers', []);
        });

        // Art mode controls
        document.getElementById('startArt').addEventListener('click', () => {
            sendCommand('startArt', {
                speakers: Array.from(selectedSpeakers),
                speakerTime: parseInt(document.getElementById('speakerTime').value) * 1000,
                quoteInterval: parseInt(document.getElementById('quoteInterval').value) * 1000,
                quotesPerSpeaker: parseInt(document.getElementById('quotesPerSpeaker').value)
            });
        });

        document.getElementById('skipSpeaker').addEventListener('click', () => {
            sendCommand('skipSpeaker', null);
        });

        document.getElementById('stopArt').addEventListener('click', () => {
            sendCommand('stopArt', null);
        });

        // Listen for updates from display
        channel.onmessage = (event) => {
            const { type, data } = event.data;

            switch (type) {
                case 'heartbeat':
                    isConnected = true;
                    document.getElementById('connectionStatus').classList.add('connected');
                    document.getElementById('connectionText').textContent = 'Connected to display';
                    break;

                case 'stats':
                    document.getElementById('quotesShown').textContent = data.quotesShown || 0;
                    document.getElementById('currentMode').textContent = data.mode || '--';
                    document.getElementById('currentSpeaker').textContent = data.currentSpeaker || '--';
                    // Sync mode buttons with actual display mode
                    if (data.mode) {
                        document.querySelectorAll('.mode-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.mode === data.mode);
                        });
                    }
                    break;

                case 'currentQuote':
                    document.getElementById('currentQuoteText').textContent = '"' + data.text + '"';
                    document.getElementById('currentQuoteSpeaker').textContent = '— ' + data.speaker;
                    break;
            }
        };

        // Ping display periodically
        setInterval(() => {
            sendCommand('ping', null);
        }, 2000);

        // Contradictions data (loaded from API)
        let contradictions = [];

        // Helper to create preview text from quote texts
        function createPreview(text1, text2) {
            const t1 = text1 ? (text1.substring(0, 25) + '...') : '';
            const t2 = text2 ? (text2.substring(0, 25) + '...') : '';
            return '"' + t1 + '" -> "' + t2 + '"';
        }

        // Load contradictions from database
        async function loadContradictions() {
            try {
                const response = await fetch('/api/data?type=contradictions&limit=200');
                const data = await response.json();
                contradictions = data.map(c => ({
                    id: c.id,
                    speaker: c.speaker,
                    speakerColor: c.speakerColor,
                    topic: c.topic,
                    quote1: c.quote1,
                    quote2: c.quote2,
                    context: c.context,
                    enabled: true
                }));
                initContradictionList();
            } catch (error) {
                console.error('Failed to load contradictions:', error);
                contradictions = [];
            }
        }

        // Format date for display
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown date';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Load stats from database
        async function loadStats() {
            try {
                const response = await fetch('/api/admin?action=stats', {
                    headers: { 'Authorization': 'Bearer ' + sessionToken }
                });
                const stats = await response.json();
                document.getElementById('totalQuotes').textContent = stats.quotes || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Delete a contradiction
        async function deleteContradiction(id) {
            try {
                const response = await fetch('/api/admin?action=contradiction', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify({ id })
                });
                if (response.ok) {
                    await loadContradictions(); // Refresh list
                } else {
                    console.error('Failed to delete contradiction:', await response.text());
                }
            } catch (error) {
                console.error('Failed to delete contradiction:', error);
            }
        }

        // Initialize contradiction list
        function initContradictionList() {
            const list = document.getElementById('contradictionList');
            list.textContent = '';

            contradictions.forEach(c => {
                const item = document.createElement('div');
                item.className = 'contradiction-item' + (c.enabled ? '' : ' disabled');
                item.dataset.id = c.id;
                if (c.speakerColor) {
                    item.style.borderLeftColor = c.speakerColor;
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = c.enabled;
                checkbox.addEventListener('change', (e) => {
                    c.enabled = e.target.checked;
                    item.classList.toggle('disabled', !c.enabled);
                    updateEnabledContradictions();
                });

                const content = document.createElement('div');
                content.className = 'contradiction-content';

                const speaker = document.createElement('div');
                speaker.className = 'contradiction-speaker';
                speaker.style.color = c.speakerColor || '#cc0000';
                speaker.textContent = c.speaker;

                const topic = document.createElement('div');
                topic.className = 'contradiction-topic';
                topic.textContent = c.topic;

                // Full quotes section
                const quotesSection = document.createElement('div');
                quotesSection.className = 'contradiction-quotes';

                // Quote 1 (Then)
                if (c.quote1) {
                    const quote1Box = document.createElement('div');
                    quote1Box.className = 'contradiction-quote-box quote1';

                    const quote1Label = document.createElement('div');
                    quote1Label.className = 'contradiction-quote-label';
                    quote1Label.textContent = 'THEN';

                    const quote1Text = document.createElement('div');
                    quote1Text.className = 'contradiction-quote-text';
                    quote1Text.textContent = '"' + c.quote1.text + '"';

                    const quote1Meta = document.createElement('div');
                    quote1Meta.className = 'contradiction-quote-meta';

                    const quote1Date = document.createElement('span');
                    quote1Date.className = 'contradiction-quote-date';
                    quote1Date.textContent = formatDate(c.quote1.date);
                    quote1Meta.appendChild(quote1Date);

                    if (c.quote1.source) {
                        const quote1Source = document.createElement('span');
                        if (c.quote1.sourceUrl) {
                            const link = document.createElement('a');
                            link.className = 'contradiction-quote-source';
                            link.href = c.quote1.sourceUrl;
                            link.target = '_blank';
                            link.textContent = c.quote1.source;
                            quote1Source.appendChild(link);
                        } else {
                            quote1Source.className = 'contradiction-quote-source';
                            quote1Source.style.color = '#888';
                            quote1Source.textContent = c.quote1.source;
                        }
                        quote1Meta.appendChild(quote1Source);
                    }

                    quote1Box.appendChild(quote1Label);
                    quote1Box.appendChild(quote1Text);
                    quote1Box.appendChild(quote1Meta);
                    quotesSection.appendChild(quote1Box);
                }

                // Quote 2 (Now)
                if (c.quote2) {
                    const quote2Box = document.createElement('div');
                    quote2Box.className = 'contradiction-quote-box quote2';

                    const quote2Label = document.createElement('div');
                    quote2Label.className = 'contradiction-quote-label';
                    quote2Label.textContent = 'NOW';

                    const quote2Text = document.createElement('div');
                    quote2Text.className = 'contradiction-quote-text';
                    quote2Text.textContent = '"' + c.quote2.text + '"';

                    const quote2Meta = document.createElement('div');
                    quote2Meta.className = 'contradiction-quote-meta';

                    const quote2Date = document.createElement('span');
                    quote2Date.className = 'contradiction-quote-date';
                    quote2Date.textContent = formatDate(c.quote2.date);
                    quote2Meta.appendChild(quote2Date);

                    if (c.quote2.source) {
                        const quote2Source = document.createElement('span');
                        if (c.quote2.sourceUrl) {
                            const link = document.createElement('a');
                            link.className = 'contradiction-quote-source';
                            link.href = c.quote2.sourceUrl;
                            link.target = '_blank';
                            link.textContent = c.quote2.source;
                            quote2Source.appendChild(link);
                        } else {
                            quote2Source.className = 'contradiction-quote-source';
                            quote2Source.style.color = '#888';
                            quote2Source.textContent = c.quote2.source;
                        }
                        quote2Meta.appendChild(quote2Source);
                    }

                    quote2Box.appendChild(quote2Label);
                    quote2Box.appendChild(quote2Text);
                    quote2Box.appendChild(quote2Meta);
                    quotesSection.appendChild(quote2Box);
                }

                content.appendChild(speaker);
                content.appendChild(topic);
                content.appendChild(quotesSection);

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'contradiction-delete';
                deleteBtn.textContent = '×';
                deleteBtn.title = 'Delete this contradiction';
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm('Delete "' + c.topic + '" contradiction for ' + c.speaker + '?')) {
                        await deleteContradiction(c.id);
                    }
                });

                item.appendChild(checkbox);
                item.appendChild(content);
                item.appendChild(deleteBtn);

                list.appendChild(item);
            });
        }

        function updateEnabledContradictions() {
            const enabled = contradictions.filter(c => c.enabled).map(c => c.id);
            sendCommand('setContradictions', enabled);
        }

        document.getElementById('enableAllContradictions').addEventListener('click', () => {
            contradictions.forEach(c => c.enabled = true);
            initContradictionList();
            updateEnabledContradictions();
        });

        document.getElementById('disableAllContradictions').addEventListener('click', () => {
            contradictions.forEach(c => c.enabled = false);
            initContradictionList();
            updateEnabledContradictions();
        });

        // Initialize control panel components - load data from API
        await loadSpeakers();
        await loadContradictions();
        await loadStats();

        // ============================================
        // Content Filtering System
        // ============================================

        let allQuotes = [];
        let activeFilters = {
            categories: [],
            rhetoric: [],
            factcheck: [],
            search: '',
            dateFrom: null,
            dateTo: null,
            speakers: []
        };

        // Load all quotes for filtering
        async function loadQuotes() {
            try {
                const response = await fetch('/api/data?type=quotes&limit=1000');
                const data = await response.json();
                allQuotes = data.quotes || data || [];
                document.getElementById('totalCount').textContent = allQuotes.length;
                document.getElementById('filteredCount').textContent = allQuotes.length;
            } catch (error) {
                console.error('Failed to load quotes:', error);
                allQuotes = [];
            }
        }

        // Initialize filter event listeners
        function initFilters() {
            // Preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyPreset(btn.dataset.preset);
                });
            });

            // Category chips
            document.querySelectorAll('.filter-chip.category').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                    updateActiveFilters();
                });
            });

            // Rhetoric chips
            document.querySelectorAll('.filter-chip.rhetoric').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                    updateActiveFilters();
                });
            });

            // Factcheck chips
            document.querySelectorAll('.filter-chip.factcheck').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('active');
                    updateActiveFilters();
                });
            });

            // Search input
            document.getElementById('quoteSearch').addEventListener('input', (e) => {
                activeFilters.search = e.target.value.toLowerCase();
                updateFilterSummary();
            });

            // Date inputs
            document.getElementById('dateFrom').addEventListener('change', (e) => {
                activeFilters.dateFrom = e.target.value || null;
                updateFilterSummary();
            });

            document.getElementById('dateTo').addEventListener('change', (e) => {
                activeFilters.dateTo = e.target.value || null;
                updateFilterSummary();
            });

            // Apply filters button
            document.getElementById('applyFilters').addEventListener('click', () => {
                applyFiltersToDisplay();
            });

            // Clear filters button
            document.getElementById('clearFilters').addEventListener('click', () => {
                clearAllFilters();
            });
        }

        function updateActiveFilters() {
            activeFilters.categories = Array.from(document.querySelectorAll('.filter-chip.category.active'))
                .map(c => c.dataset.category);
            activeFilters.rhetoric = Array.from(document.querySelectorAll('.filter-chip.rhetoric.active'))
                .map(c => c.dataset.rhetoric);
            activeFilters.factcheck = Array.from(document.querySelectorAll('.filter-chip.factcheck.active'))
                .map(c => c.dataset.factcheck);
            updateFilterSummary();
        }

        function getFilteredQuotes() {
            return allQuotes.filter(quote => {
                // Speaker filter
                if (selectedSpeakers.size > 0 && !selectedSpeakers.has(quote.speaker_id || quote.speakerId)) {
                    return false;
                }

                // Category filter
                if (activeFilters.categories.length > 0) {
                    const quoteCategories = quote.categories || [];
                    if (!activeFilters.categories.some(c => quoteCategories.includes(c))) {
                        return false;
                    }
                }

                // Rhetoric filter
                if (activeFilters.rhetoric.length > 0) {
                    const quoteRhetoric = quote.rhetoric || [];
                    if (!activeFilters.rhetoric.some(r => quoteRhetoric.includes(r))) {
                        return false;
                    }
                }

                // Fact-check filter
                if (activeFilters.factcheck.length > 0) {
                    const rating = (quote.fact_check_rating || quote.factCheckRating || '').toLowerCase();
                    if (!activeFilters.factcheck.some(f => rating.includes(f.replace('-', ' ')))) {
                        return false;
                    }
                }

                // Search filter
                if (activeFilters.search) {
                    const text = (quote.text || '').toLowerCase();
                    if (!text.includes(activeFilters.search)) {
                        return false;
                    }
                }

                // Date filter
                if (activeFilters.dateFrom && quote.date) {
                    if (quote.date < activeFilters.dateFrom) return false;
                }
                if (activeFilters.dateTo && quote.date) {
                    if (quote.date > activeFilters.dateTo) return false;
                }

                return true;
            });
        }

        function updateFilterSummary() {
            const filtered = getFilteredQuotes();
            document.getElementById('filteredCount').textContent = filtered.length;
        }

        function applyPreset(preset) {
            // Clear all filters first
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('quoteSearch').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            activeFilters = {
                categories: [],
                rhetoric: [],
                factcheck: [],
                search: '',
                dateFrom: null,
                dateTo: null,
                speakers: []
            };

            // Apply preset
            switch (preset) {
                case 'all':
                    // No filters
                    break;
                case 'contradictions':
                    // Show only contradictions mode
                    sendCommand('setMode', 'contradiction');
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-mode="contradiction"]').classList.add('active');
                    break;
                case 'factcheck':
                    document.querySelectorAll('.filter-chip.factcheck').forEach(c => c.classList.add('active'));
                    activeFilters.factcheck = ['false', 'pants-on-fire', 'mostly-false'];
                    break;
                case 'immigration':
                    document.querySelector('[data-category="immigration"]').classList.add('active');
                    activeFilters.categories = ['immigration'];
                    break;
                case 'election':
                    document.querySelector('[data-category="election"]').classList.add('active');
                    activeFilters.categories = ['election'];
                    break;
                case 'dehumanizing':
                    document.querySelector('[data-rhetoric="dehumanizing"]').classList.add('active');
                    activeFilters.rhetoric = ['dehumanizing'];
                    break;
            }

            updateFilterSummary();
            applyFiltersToDisplay();
        }

        function applyFiltersToDisplay() {
            const filtered = getFilteredQuotes();
            const quoteIds = filtered.map(q => q.id);

            // Send filter command to display
            sendCommand('setQuoteFilter', {
                quoteIds: quoteIds,
                categories: activeFilters.categories,
                rhetoric: activeFilters.rhetoric,
                factcheck: activeFilters.factcheck,
                speakers: Array.from(selectedSpeakers)
            });

            console.log('Applied filters:', activeFilters);
            console.log('Filtered quotes:', filtered.length);
        }

        function clearAllFilters() {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-preset="all"]').classList.add('active');
            document.getElementById('quoteSearch').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';

            activeFilters = {
                categories: [],
                rhetoric: [],
                factcheck: [],
                search: '',
                dateFrom: null,
                dateTo: null,
                speakers: []
            };

            updateFilterSummary();
            sendCommand('clearFilters', null);
        }

        // Call filter initialization at the end
        await loadQuotes();
        initFilters();

        } // End initializeControlPanel()
    </script>
</body>
</html>
